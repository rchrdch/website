import { applyPolyfills, NodeApp } from "astro/app/node";
import { ASTRO_PATH_HEADER, ASTRO_LOCALS_HEADER } from "./adapter.js";
applyPolyfills();
const createExports = (manifest) => {
  const app = new NodeApp(manifest);
  const handler = async (req, res) => {
    const clientAddress = req.headers["x-forwarded-for"];
    const localsHeader = req.headers[ASTRO_LOCALS_HEADER];
    const realPath = req.headers[ASTRO_PATH_HEADER];
    if (typeof realPath === "string") {
      req.url = realPath;
    }
    const locals = typeof localsHeader === "string" ? JSON.parse(localsHeader) : Array.isArray(localsHeader) ? JSON.parse(localsHeader[0]) : {};
    const webResponse = await app.render(req, { addCookieHeader: true, clientAddress, locals });
    await NodeApp.writeResponse(webResponse, res);
  };
  return { default: handler };
};
export {
  createExports
};
